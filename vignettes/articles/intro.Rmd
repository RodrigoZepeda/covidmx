---
title: "Introducción a covidmx"
author: "Rodrigo Zepeda-Tello"
output: pdf_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

La librería de `covidmx` está para ayudarte a analizar los datos abiertos de COVID-19 de México, generar estadísticos de interés y visualizaciones rápidas. La idea es ahorrarte tiempo. 

## Instalación

```{r install, eval = FALSE}
#install.packages("devtools")
devtools::install_github("RodrigoZepeda/covidmx")
```

## Descarga de datos de la Dirección General de Epidemiología 

> **NOTA** Necesitas tener una instalación de `MariaDB` o bien muchísima `RAM`. Para 
instalar `MariaDB` puedes revisar [el artículo respectivo](https://rodrigozepeda.github.io/covidmx/articles/Instalacion_de_MARIADB.html).


```{r setup, message=FALSE, warning=FALSE, results='hide'}
library(covidmx)
library(dplyr)
```

Lo más importante es comenzar descargando la base de datos pública. Esto lo puedes hacer como sigue: 

```{r descarga, eval = FALSE}
datos_covid <- descarga_datos_abiertos(language = "Español")
```

```{r lectura, echo = FALSE, message=FALSE, warning=FALSE}
datos_covid <- read_datos_abiertos()
```

La descarga contiene una lista la información de interés está en `datos_covid$dats`

Por default **NO** se agregan las etiquetas a los datos pues es muy tardado hacerlo: 

```{r glimpse-1}
datos_covid$dats %>% dplyr::glimpse()
```

Sin embargo se guardan como una lista en `dict` para su consulta y uso por las funciones internas:

```{r glimpse-2}
datos_covid$dict %>% dplyr::glimpse()
```

por ejemplo para ver el diccionario de antígeno:
```{r glimpse-3}
datos_covid$dict$RESULTADO_ANTIGENO
```

De hecho no es necesario volver a descargar si reinicias tu sesión de `R` siempre y cuando los hayas guardado en `MariaDB` (el default). Puedes sólo leer los datos abiertos que ya tienes usando la función `read_datos_abiertos.R`;

```{r, eval = TRUE}
read_datos_abiertos() %>% glimpse()
```

Una vez descargados (o leídos), basta componer la base de datos con cualquiera de las funciones para tener una tabla de datos agregada por fecha y entidad. 

## Casos de covid

Las bases de datos se agregan a la lista bajo el nombre default `casos`. Por ejemplo:

```{r, eval = TRUE}
datos_covid <- datos_covid %>% casos()
```

El objeto `casos` por default es un `tibble` con el que ya puedes operar:
```{r}
datos_covid$casos %>% head()
```

Nota que lo que hace es agregar por fecha y por entidad de la unidad médica los casos. 

Se puede filtar por entidad de la unidad médica seleccionando las entidades de interés:
```{r, eval = FALSE}
datos_covid %>% 
  casos(entidades = c("QUINTANA ROO","AGUASCALIENTES")) 
```

```{r, echo = FALSE}
head((datos_covid %>% 
  casos(entidades = c("QUINTANA ROO","AGUASCALIENTES"), list_name = "prueba"))$prueba)
```

Si se quiere filtrar por entidad de nacimiento y que la fecha sea la de ingreso, por ejemplo:

```{r, eval = FALSE}
datos_covid %>% 
    casos(entidades    = c("QUINTANA ROO","AGUASCALIENTES"),
          entidad_tipo = "Nacimiento",
          fecha_tipo   = "Ingreso") 
```

```{r, echo = FALSE}
tf <- datos_covid %>% 
  casos(entidades    = c("QUINTANA ROO","AGUASCALIENTES"), 
        entidad_tipo = "Nacimiento",
        fecha_tipo   = "Ingreso", list_name = "prueba")
```

```{r, echo = FALSE}
head(tf$prueba %>% arrange(FECHA_INGRESO, ENTIDAD_NAC))
```

Finalmente, si sólo se desean casos confirmados e inválidos:

```{r, eval = FALSE}
datos_covid %>% 
    casos(entidades    = c("QUINTANA ROO","AGUASCALIENTES"),
          entidad_tipo = "Nacimiento",
          fecha_tipo   = "Ingreso",
          tipo_clasificacion = c("Confirmados COVID", "Invalido"))
```

```{r, echo = FALSE}
tf <- datos_covid %>% 
    casos(entidades    = c("QUINTANA ROO","AGUASCALIENTES"),
          entidad_tipo = "Nacimiento",
          fecha_tipo   = "Ingreso",
          tipo_clasificacion = c("Confirmados COVID", "Invalido"), list_name = "prueba") 

head(tf$prueba %>% arrange(FECHA_INGRESO, ENTIDAD_NAC))
```
Nota que por default el programa rellena con ceros lo que no se observó. Si quieres cancelar esta opción basta con cambiar `fill_zeros = FALSE`: 

```{r, eval = FALSE}
datos_covid %>% 
    casos(entidades    = c("QUINTANA ROO","AGUASCALIENTES"),
          entidad_tipo = "Nacimiento",
          fecha_tipo   = "Ingreso",
          tipo_clasificacion = c("Confirmados COVID", "Invalido"),
          fill_zeros = FALSE)
```

```{r, echo = FALSE}
tf <- datos_covid %>% 
    casos(entidades    = c("QUINTANA ROO","AGUASCALIENTES"),
          entidad_tipo = "Nacimiento",
          fecha_tipo   = "Ingreso",
          tipo_clasificacion = c("Confirmados COVID", "Invalido"), 
          fill_zeros = FALSE, 
          list_name = "prueba") 

head(tf$prueba %>% arrange(FECHA_INGRESO, ENTIDAD_NAC))
```

Si se desea que los casos vengan agregados (es decir `QUINTANA ROO + AGUASCALIENTES`)
se puede cambiar la opción de `group_by_entidad` a `FALSE`:

```{r, eval = FALSE}
datos_covid %>% 
    casos(entidades          = c("QUINTANA ROO","AGUASCALIENTES"),
          entidad_tipo       = "Nacimiento",
          fecha_tipo         = "Ingreso",
          tipo_clasificacion = c("Confirmados COVID", "Invalido"),
          group_by_entidad   = FALSE) 
```

```{r, echo = FALSE}
tf <- datos_covid %>% 
    casos(entidades        = c("QUINTANA ROO","AGUASCALIENTES"),
          entidad_tipo     = "Nacimiento",
          fecha_tipo       = "Ingreso",
          tipo_clasificacion = c("Confirmados COVID", "Invalido"),
          group_by_entidad = FALSE,
          list_name        = "prueba") 

head(tf$prueba %>% arrange(FECHA_INGRESO))
```

La variable `edad_cut` te permite quedarte sòlo con un grupo de edad o bien definir múltiples. Por ejemplo para quedarte sólo con los casos de 5 a 25 años:

```{r, eval = FALSE}
datos_covid %>% 
  casos(edad_cut = c(5, 25)) 
```

```{r, echo = FALSE}
head((datos_covid %>% 
  casos(edad_cut = c(5, 25), list_name = "prueba"))$prueba)
```

O bien definir grupos de edad de la forma `0-20`, `20-60` y `60+`

```{r, eval = FALSE}
datos_covid %>% 
  casos(edad_cut = c(0, 20, 60, Inf)) 
```

```{r, echo = FALSE}
head((datos_covid %>% 
  casos(edad_cut = c(0, 20, 60, Inf), list_name = "prueba"))$prueba)
```

Puedes acumular diferentes bases de datos en la misma lista asignándoles nombres: 

```{r, eval = TRUE}
datos_covid <- datos_covid %>% 
  casos(list_name = "Todos por entidad") %>%
  casos(list_name = "Todos (nacional)", group_by_entidad = FALSE) %>% 
  casos(list_name = "Defunciones (todos)", defunciones = TRUE) 

message("Todos (nacional)")
datos_covid$`Todos (nacional)` %>% head()

message("Todos por entidad")
datos_covid$`Todos por entidad` %>% head()

message("Defunciones (todos)")
datos_covid$`Defunciones (todos)` %>% head()
```

Hay múltiples opciones permitiendo seleccionar variables específicas de unidades de cuidado intensivo, defunciones y si devolver la tabla como `tibble` o como conexión de `dbplyr` a `MARIADB`:

```{r, eval = TRUE}
datos_covid <- datos_covid %>% 
  casos(
    #Lista de entidades que deseas
    entidades = c("AGUASCALIENTES", "BAJA CALIFORNIA", "BAJA CALIFORNIA SUR",
                      "CAMPECHE", "CHIAPAS", "CHIHUAHUA","CIUDAD DE M\u00c9XICO",
                      "COAHUILA DE ZARAGOZA" , "COLIMA", "DURANGO", "GUANAJUATO",
                      "GUERRERO","HIDALGO", "JALISCO", "M\u00c9XICO",
                      "MICHOAC\u00c1N DE OCAMPO", "MORELOS","NAYARIT",
                      "NUEVO LE\u00d3N", "OAXACA", "PUEBLA", "QUER\u00c9TARO",
                      "QUINTANA ROO", "SAN LUIS POTOS\u00cd", "SINALOA", "SONORA",
                      "TABASCO", "TAMAULIPAS", "TLAXCALA", "VERACRUZ DE IGNACIO DE LA LLAVE", 
                      "YUCAT\u00c1N", "ZACATECAS"),
    
    #Si quieres que los resultados salgan por entidad = TRUE o ya agregados = FALSE
    group_by_entidad   = TRUE,
    
    #Selecciona esas entidades a qué tipo de entidad refieren: Unidad Médica, Residencia, Nacimiento
    entidad_tipo       = "Residencia", #c("Unidad M\u00e9dica", "Residencia", "Nacimiento"),
    
    #Selecciona la fecha para la base de datos: Síntomas, Ingreso, Defunción
    fecha_tipo         = "Ingreso",
    
    #Selecciona todas las variables de clasificación que deseas agregar:
    tipo_clasificacion = c("Sospechosos","Confirmados COVID", "Negativo a COVID", "Inválido", 
                           "No realizado"),
    
    #Selecciona si deseas agrupar por la variable tipo_clasificacion
    group_by_tipo_clasificacion = TRUE,
    
    #Selecciona todos los pacientes quieres incluir:
    tipo_paciente       = c("AMBULATORIO", "HOSPITALIZADO", "NO ESPECIFICADO"),
    
    #Selecciona si agrupar por tipo de paciente
    group_by_tipo_paciente = TRUE,
    
    #Selecciona todas las opciones de Unidad de Cuidado Intensivo del paciente:
    tipo_uci      = c("SI","NO","NO APLICA","SE IGNORA","NO ESPECIFICADO"),
    
    #Selecciona si agrupar por tipo de unidad
    group_by_tipo_uci  = TRUE,
    
    #Selecciona los sectores del sistema de salud a incluir
    tipo_sector   = c("CRUZ ROJA", "DIF", "ESTATAL", "IMSS", "IMSS-BIENESTAR", "ISSSTE", 
                      "MUNICIPAL", "PEMEX", "PRIVADA", "SEDENA", "SEMAR", "SSA", 
                      "UNIVERSITARIO","NO ESPECIFICADO"),
    
    #Selecciona si deseas agrupar por tipo de sector
    group_by_tipo_sector = FALSE,
    
    #Selecciona si deseas sólo los que tuvieron defunción
    defunciones   = TRUE,
    
    #Selecciona los grupos de edad que deseas incluir en rango
    edad_cut      = c(20, 40, 60), #Edades 20-40 y 40-60
    
    #Selecciona si devolver el objeto como tibble
    as_tibble     = TRUE,
    
    #Selecciona si rellenar los conteos (n) con ceros cuando no haya observaciones.
    fill_zeros    = TRUE,
    
    #Nombre para llamarle en el objeto lista que regresa
    list_name     = "Ejemplo defunciones",
    
    #Agrupa los resultados además por estado de diabetes y sexo
    .grouping_vars = c("DIABETES", "SEXO"))
```

Puedes ver la base generada así:
```{r}
datos_covid$`Ejemplo defunciones` %>% head()
```

## Desconexión

Una vez que terminaste de trabajar con la base original en `MariaDB` deconecta el puntero haciendo:

```{r}
datos_covid$disconnect()
```

## Datos de variantes

Para descargar las variantes reportadas por la publicación diaria en Github del reporte nacional en [RodrigoZepeda/VariantesCovid](https://github.com/RodrigoZepeda/VariantesCovid) a partir de las variantes de [GISAID](www.gisaid.org) puedes hacer:

```{r}
variantes_covid <- descarga_datos_variantes_GISAID()
```

Los datos se ven así:

```{r}
variantes_covid %>% head()
```

Por `default` baja nacional pero también puedes usar "cdmx":

```{r}
variantes_covid <- descarga_datos_variantes_GISAID("cdmx")
```


> No olvides citar a **GISAID** así como a la publicación diaria en [RodrigoZepeda/VariantesCovid](https://github.com/RodrigoZepeda/VariantesCovid) si las usas. 

## Datos de ocupación hospitalaria (Red IRAG)

Puedes descargar los datos de la [Red IRAG](https://www.gits.igg.unam.mx/red-irag-dashboard/reviewHome#) de ocupación hospitalaria
a nivel estatal o a nivel unidad médica mediante `descarga_datos_ocupacion_hospitalaria`. Estos se obtienen de la publicación diaria en [RodrigoZepeda/CapacidadHospitalariaMX](https://github.com/RodrigoZepeda/CapacidadHospitalariaMX). 

```{r}
estatales <- descarga_datos_ocupacion_hospitalaria()
```

Los cuales se ven así:
```{r ocupacion, fig.height=32, fig.width=8}
estatales %>% plot_covid(df_covariates = "estado")
```
O bien por unidad médica:


```{r}
unidad_medica <- descarga_datos_ocupacion_hospitalaria(nivel = "Unidad Médica")
```
que se ven así: 
```{r}
unidad_medica %>% head()
```

> No olvides citar a **RED IRAG** así como a la publicación diaria en [RodrigoZepeda/CapacidadHospitalariaMX](https://github.com/RodrigoZepeda/CapacidadHospitalariaMX) si las usas. 

## Gráficas 

Para graficar puedes usar la función `plot_covid` por default grafica lo que està en `datos_covid$casos` 

```{r nacionalentidad, fig.height=16, fig.width=8}
datos_covid %>% plot_covid()
```


pero puedes pedir otra con el eje x más limpio:

```{r nacional}
datos_covid %>% plot_covid("Todos (nacional)", 
                           date_break_format = "6 months",
                           date_labels_format = "%m/%y")
```

Para visualizar un suavizamiento con _splines_ cambia el `type` y dale las opciones que darías a `geom_spline`: 
```{r splineacional}
datos_covid %>% plot_covid("Todos (nacional)", type = "spline", spar = 0.5)
```

Puedes visualizar hasta dos covariables a la vez con `df_covariates` y decirle cuál graficar con `df_variable`:
```{r, fig.height=32, fig.width=8}
datos_covid %>% 
  plot_covid("Ejemplo defunciones", 
             df_variable = "n", 
             df_covariates = c("SEXO","ENTIDAD_FEDERATIVA"),
             type = "area") 
```

## Otras funciones de interés

Faltan por desarrollar las siguientes funciones:

```{r, eval = FALSE}
positividad()               #Positividad en pruebas
cfr()                       #Case fatality rate
chr()                       #Case hospitalization rate
rt()                        #Effective reproductive number
predice()                   #Función para predecir casos en automático
suaviza()                   #Suavizamiento de los casos observados
descarga_datos_cdmx()       #Descarga de datos abiertos cdmx
```


